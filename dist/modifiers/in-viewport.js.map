{"version":3,"file":"in-viewport.js","sources":["../../src/modifiers/in-viewport.js"],"sourcesContent":["import { assert } from '@ember/debug';\nimport { action } from '@ember/object';\nimport { inject as service } from '@ember/service';\nimport { DEBUG } from '@glimmer/env';\nimport Modifier from 'ember-modifier';\nimport deepEqual from 'fast-deep-equal';\nimport { registerDestructor } from '@ember/destroyable';\nimport { macroCondition, dependencySatisfies } from '@embroider/macros';\n\nconst WATCHED_ELEMENTS = DEBUG ? new WeakSet() : undefined;\n\nlet modifier;\n\nif (macroCondition(dependencySatisfies('ember-modifier', '>=3.2.0 || 4.x'))) {\n  modifier = class InViewportModifier extends Modifier {\n    @service inViewport;\n\n    name = 'in-viewport';\n\n    lastOptions;\n    element = null;\n\n    modify(element, positional, named) {\n      this.element = element;\n      this.positional = positional;\n      this.named = named;\n      this.validateArguments();\n\n      if (!this.didSetup) {\n        this.setupWatcher(element);\n        registerDestructor(() => this.destroyWatcher(element));\n      } else if (this.hasStaleOptions) {\n        this.destroyWatcher(element);\n        this.setupWatcher(element);\n      }\n    }\n\n    get options() {\n      // eslint-disable-next-line no-unused-vars\n      const { onEnter, onExit, ...options } = this.named;\n      return options;\n    }\n\n    get hasStaleOptions() {\n      return !deepEqual(this.options, this.lastOptions);\n    }\n\n    validateArguments() {\n      assert(\n        `'{{in-viewport}}' does not accept positional parameters. Specify listeners via 'onEnter' / 'onExit'.`,\n        this.positional.length === 0,\n      );\n      assert(\n        `'{{in-viewport}}' either expects 'onEnter', 'onExit' or both to be present.`,\n        typeof this.named.onEnter === 'function' ||\n          typeof this.named.onExit === 'function',\n      );\n    }\n\n    @action\n    onEnter(...args) {\n      if (this.named.onEnter) {\n        this.named.onEnter.call(null, this.element, ...args);\n      }\n\n      if (!this.options.viewportSpy) {\n        this.inViewport.stopWatching(this.element);\n      }\n    }\n\n    @action\n    onExit(...args) {\n      if (this.named.onExit) {\n        this.named.onExit.call(null, this.element, ...args);\n      }\n    }\n\n    setupWatcher(element) {\n      assert(\n        `'${element}' is already being watched. Make sure that '{{in-viewport}}' is only used once on this element and that you are not calling 'inViewport.watchElement(element)' in other places.`,\n        !WATCHED_ELEMENTS.has(element),\n      );\n      if (DEBUG) WATCHED_ELEMENTS.add(element);\n      this.inViewport.watchElement(\n        element,\n        this.options,\n        this.onEnter,\n        this.onExit,\n      );\n      this.lastOptions = this.options;\n    }\n\n    destroyWatcher(element) {\n      if (DEBUG) WATCHED_ELEMENTS.delete(element);\n      this.inViewport.stopWatching(element);\n    }\n  };\n} else {\n  modifier = class InViewportModifier extends Modifier {\n    @service inViewport;\n\n    name = 'in-viewport';\n\n    lastOptions;\n\n    get options() {\n      // eslint-disable-next-line no-unused-vars\n      const { onEnter, onExit, ...options } = this.args.named;\n      return options;\n    }\n\n    get hasStaleOptions() {\n      return !deepEqual(this.options, this.lastOptions);\n    }\n\n    validateArguments() {\n      assert(\n        `'{{in-viewport}}' does not accept positional parameters. Specify listeners via 'onEnter' / 'onExit'.`,\n        this.args.positional.length === 0,\n      );\n      assert(\n        `'{{in-viewport}}' either expects 'onEnter', 'onExit' or both to be present.`,\n        typeof this.args.named.onEnter === 'function' ||\n          typeof this.args.named.onExit === 'function',\n      );\n    }\n\n    @action\n    onEnter(...args) {\n      if (this.args.named.onEnter) {\n        this.args.named.onEnter.call(null, this.element, ...args);\n      }\n\n      if (!this.options.viewportSpy) {\n        this.inViewport.stopWatching(this.element);\n      }\n    }\n\n    @action\n    onExit(...args) {\n      if (this.args.named.onExit) {\n        this.args.named.onExit.call(null, this.element, ...args);\n      }\n    }\n\n    setupWatcher() {\n      assert(\n        `'${this.element}' is already being watched. Make sure that '{{in-viewport}}' is only used once on this element and that you are not calling 'inViewport.watchElement(element)' in other places.`,\n        !WATCHED_ELEMENTS.has(this.element),\n      );\n      if (DEBUG) WATCHED_ELEMENTS.add(this.element);\n      this.inViewport.watchElement(\n        this.element,\n        this.options,\n        this.onEnter,\n        this.onExit,\n      );\n      this.lastOptions = this.options;\n    }\n\n    destroyWatcher() {\n      if (DEBUG) WATCHED_ELEMENTS.delete(this.element);\n      this.inViewport.stopWatching(this.element);\n    }\n\n    didInstall() {\n      this.setupWatcher();\n    }\n\n    didUpdateArguments() {\n      if (this.hasStaleOptions) {\n        this.destroyWatcher();\n        this.setupWatcher();\n      }\n    }\n\n    didReceiveArguments() {\n      this.validateArguments();\n    }\n\n    willRemove() {\n      this.destroyWatcher();\n    }\n  };\n}\n\nexport default modifier;\n"],"names":["WATCHED_ELEMENTS","DEBUG","WeakSet","undefined","modifier","macroCondition","dependencySatisfies","_class","_descriptor","InViewportModifier","Modifier","constructor","args","_initializerDefineProperty","_defineProperty","modify","element","positional","named","validateArguments","didSetup","setupWatcher","registerDestructor","destroyWatcher","hasStaleOptions","options","onEnter","onExit","deepEqual","lastOptions","assert","length","call","viewportSpy","inViewport","stopWatching","has","add","watchElement","delete","_applyDecoratedDescriptor","prototype","service","configurable","enumerable","writable","initializer","action","Object","getOwnPropertyDescriptor","_class2","_descriptor2","didInstall","didUpdateArguments","didReceiveArguments","willRemove"],"mappings":"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"}