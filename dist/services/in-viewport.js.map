{"version":3,"file":"in-viewport.js","sources":["../../src/services/in-viewport.js"],"sourcesContent":["import Service from '@ember/service';\nimport { set, setProperties } from '@ember/object';\nimport { getOwner } from '@ember/application';\nimport { warn } from '@ember/debug';\nimport { schedule } from '@ember/runloop';\nimport isInViewport from 'ember-in-viewport/utils/is-in-viewport';\nimport canUseRAF from 'ember-in-viewport/utils/can-use-raf';\nimport canUseIntersectionObserver from 'ember-in-viewport/utils/can-use-intersection-observer';\nimport ObserverAdmin from 'ember-in-viewport/-private/observer-admin';\nimport RAFAdmin, { startRAF } from 'ember-in-viewport/-private/raf-admin';\n\nconst noop = () => {};\n\n/**\n * ensure use on requestAnimationFrame, no matter how many components\n * on the page are using this class\n *\n * @class InViewport\n * @module Ember.Service\n */\nexport default class InViewport extends Service {\n  constructor() {\n    super(...arguments);\n\n    set(this, 'registry', new WeakMap());\n\n    let options = Object.assign(\n      {\n        viewportUseRAF: canUseRAF(),\n      },\n      this._buildOptions(),\n    );\n\n    // set viewportUseIntersectionObserver after merging users config to avoid errors in browsers that lack support (https://github.com/DockYard/ember-in-viewport/issues/146)\n    options = Object.assign(options, {\n      viewportUseIntersectionObserver: canUseIntersectionObserver(),\n    });\n\n    setProperties(this, options);\n  }\n\n  startIntersectionObserver() {\n    this.observerAdmin = new ObserverAdmin();\n  }\n\n  startRAF() {\n    this.rafAdmin = new RAFAdmin();\n  }\n\n  /** Any strategy **/\n\n  /**\n   * @method watchElement\n   * @param HTMLElement element\n   * @param Object configOptions\n   * @param Function enterCallback\n   * @param Function exitCallback\n   * @void\n   */\n  watchElement(element, configOptions = {}, enterCallback, exitCallback) {\n    if (this.viewportUseIntersectionObserver) {\n      if (!this.observerAdmin) {\n        this.startIntersectionObserver();\n      }\n      const observerOptions = this.buildObserverOptions(configOptions);\n\n      schedule(\n        'afterRender',\n        this,\n        this.setupIntersectionObserver,\n        element,\n        observerOptions,\n        enterCallback,\n        exitCallback,\n      );\n    } else {\n      if (!this.rafAdmin) {\n        this.startRAF();\n      }\n      schedule(\n        'afterRender',\n        this,\n        this._startRaf,\n        element,\n        configOptions,\n        enterCallback,\n        exitCallback,\n      );\n    }\n\n    return {\n      onEnter: this.addEnterCallback.bind(this, element),\n      onExit: this.addExitCallback.bind(this, element),\n    };\n  }\n\n  /**\n   * @method addEnterCallback\n   * @void\n   */\n  addEnterCallback(element, enterCallback) {\n    if (this.viewportUseIntersectionObserver) {\n      this.observerAdmin.addEnterCallback(element, enterCallback);\n    } else {\n      this.rafAdmin.addEnterCallback(element, enterCallback);\n    }\n  }\n\n  /**\n   * @method addExitCallback\n   * @void\n   */\n  addExitCallback(element, exitCallback) {\n    if (this.viewportUseIntersectionObserver) {\n      this.observerAdmin.addExitCallback(element, exitCallback);\n    } else {\n      this.rafAdmin.addExitCallback(element, exitCallback);\n    }\n  }\n\n  /** IntersectionObserver **/\n\n  /**\n   * In order to track elements and the state that comes with them, we need to keep track\n   * of elements in order to get at them at a later time, specifically to unobserve\n   *\n   * @method addToRegistry\n   * @void\n   */\n  addToRegistry(element, observerOptions) {\n    if (this.registry) {\n      this.registry.set(element, { observerOptions });\n    } else {\n      warn('in-viewport Service has already been destroyed');\n    }\n  }\n\n  /**\n   * @method setupIntersectionObserver\n   * @param HTMLElement element\n   * @param Object observerOptions\n   * @param Function enterCallback\n   * @param Function exitCallback\n   * @void\n   */\n  setupIntersectionObserver(\n    element,\n    observerOptions,\n    enterCallback,\n    exitCallback,\n  ) {\n    if (this.isDestroyed || this.isDestroying) {\n      return;\n    }\n\n    this.addToRegistry(element, observerOptions);\n\n    this.observerAdmin.add(\n      element,\n      observerOptions,\n      enterCallback,\n      exitCallback,\n    );\n  }\n\n  buildObserverOptions({\n    intersectionThreshold = 0,\n    scrollableArea = null,\n    viewportTolerance = {},\n  }) {\n    const domScrollableArea =\n      typeof scrollableArea === 'string' && scrollableArea\n        ? document.querySelector(scrollableArea)\n        : scrollableArea instanceof HTMLElement\n          ? scrollableArea\n          : undefined;\n\n    // https://developer.mozilla.org/en-US/docs/Web/API/Intersection_Observer_API\n    // IntersectionObserver takes either a Document Element or null for `root`\n    const { top = 0, left = 0, bottom = 0, right = 0 } = viewportTolerance;\n    return {\n      root: domScrollableArea,\n      rootMargin: `${top}px ${right}px ${bottom}px ${left}px`,\n      threshold: intersectionThreshold,\n    };\n  }\n\n  unobserveIntersectionObserver(target) {\n    if (!target) {\n      return;\n    }\n\n    const registeredTarget = this.registry.get(target);\n    if (typeof registeredTarget === 'object') {\n      this.observerAdmin.unobserve(target, registeredTarget.observerOptions);\n    }\n  }\n\n  /** RAF **/\n\n  addRAF(elementId, fn) {\n    this.rafAdmin.add(elementId, fn);\n  }\n\n  removeRAF(elementId) {\n    if (this.rafAdmin) {\n      this.rafAdmin.remove(elementId);\n    }\n  }\n\n  isInViewport(...args) {\n    return isInViewport(...args);\n  }\n\n  /** other **/\n  stopWatching(target) {\n    if (this.observerAdmin) {\n      this.unobserveIntersectionObserver(target);\n    }\n    if (this.rafAdmin) {\n      this.removeRAF(target);\n    }\n  }\n\n  willDestroy() {\n    set(this, 'registry', null);\n    if (this.observerAdmin) {\n      this.observerAdmin.destroy();\n      set(this, 'observerAdmin', null);\n    }\n    if (this.rafAdmin) {\n      this.rafAdmin.reset();\n      set(this, 'rafAdmin', null);\n    }\n  }\n\n  _buildOptions(defaultOptions = {}) {\n    const owner = getOwner(this);\n\n    if (owner) {\n      return Object.assign(defaultOptions, owner.lookup('config:in-viewport'));\n    }\n  }\n\n  _startRaf(element, configOptions, enterCallback, exitCallback) {\n    if (this.isDestroyed || this.isDestroying) {\n      return;\n    }\n\n    enterCallback = enterCallback || noop;\n    exitCallback = exitCallback || noop;\n\n    // this isn't using the same functions as the RAFAdmin, but that is b/c it is a bit harder to unwind.\n    // So just rewrote it with pure functions for now\n    startRAF(\n      element,\n      configOptions,\n      enterCallback,\n      exitCallback,\n      this.addRAF.bind(this, element.id),\n      this.removeRAF.bind(this, element.id),\n    );\n  }\n}\n"],"names":["noop","InViewport","Service","constructor","arguments","set","WeakMap","options","Object","assign","viewportUseRAF","canUseRAF","_buildOptions","viewportUseIntersectionObserver","canUseIntersectionObserver","setProperties","startIntersectionObserver","observerAdmin","ObserverAdmin","startRAF","rafAdmin","RAFAdmin","watchElement","element","configOptions","enterCallback","exitCallback","observerOptions","buildObserverOptions","schedule","setupIntersectionObserver","_startRaf","onEnter","addEnterCallback","bind","onExit","addExitCallback","addToRegistry","registry","warn","isDestroyed","isDestroying","add","intersectionThreshold","scrollableArea","viewportTolerance","domScrollableArea","document","querySelector","HTMLElement","undefined","top","left","bottom","right","root","rootMargin","threshold","unobserveIntersectionObserver","target","registeredTarget","get","unobserve","addRAF","elementId","fn","removeRAF","remove","isInViewport","args","stopWatching","willDestroy","destroy","reset","defaultOptions","owner","getOwner","lookup","id"],"mappings":"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"}