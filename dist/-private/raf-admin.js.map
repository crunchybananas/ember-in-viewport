{"version":3,"file":"raf-admin.js","sources":["../../src/-private/raf-admin.js"],"sourcesContent":["import RafPool from 'raf-pool';\nimport isInViewport from 'ember-in-viewport/utils/is-in-viewport';\n\n/**\n * ensure use on requestAnimationFrame, no matter how many components\n * on the page are using this class\n *\n * @class RAFAdmin\n */\nexport default class RAFAdmin {\n  /** @private **/\n  constructor() {\n    this._rafPool = new RafPool();\n    this.elementRegistry = new WeakMap();\n  }\n\n  add(...args) {\n    return this._rafPool.add(...args);\n  }\n\n  flush() {\n    return this._rafPool.flush();\n  }\n\n  remove(...args) {\n    return this._rafPool.remove(...args);\n  }\n\n  reset(...args) {\n    this._rafPool.reset(...args);\n    this._rafPool.stop(...args);\n  }\n\n  /**\n   * We provide our own element registry to add callbacks the user creates\n   *\n   * @method addEnterCallback\n   * @param {HTMLElement} element\n   * @param {Function} enterCallback\n   */\n  addEnterCallback(element, enterCallback) {\n    this.elementRegistry.set(\n      element,\n      Object.assign({}, this.elementRegistry.get(element), { enterCallback }),\n    );\n  }\n\n  /**\n   * We provide our own element registry to add callbacks the user creates\n   *\n   * @method addExitCallback\n   * @param {HTMLElement} element\n   * @param {Function} exitCallback\n   */\n  addExitCallback(element, exitCallback) {\n    this.elementRegistry.set(\n      element,\n      Object.assign({}, this.elementRegistry.get(element), { exitCallback }),\n    );\n  }\n}\n\n/**\n * This is a recursive function that adds itself to raf-pool to be executed on a set schedule\n *\n * @method startRAF\n * @param {HTMLElement} element\n * @param {Object} configurationOptions\n * @param {Function} enterCallback\n * @param {Function} exitCallback\n * @param {Function} addRAF\n * @param {Function} removeRAF\n */\nexport function startRAF(\n  element,\n  { scrollableArea, viewportTolerance, viewportSpy = false },\n  enterCallback,\n  exitCallback,\n  addRAF, // bound function from service to add elementId to raf pool\n  removeRAF, // bound function from service to remove elementId to raf pool\n) {\n  const domScrollableArea =\n    typeof scrollableArea === 'string' && scrollableArea\n      ? document.querySelector(scrollableArea)\n      : scrollableArea instanceof HTMLElement\n        ? scrollableArea\n        : undefined;\n\n  const height = domScrollableArea\n    ? domScrollableArea.offsetHeight +\n      domScrollableArea.getBoundingClientRect().top\n    : window.innerHeight;\n  const width = scrollableArea\n    ? domScrollableArea.offsetWidth +\n      domScrollableArea.getBoundingClientRect().left\n    : window.innerWidth;\n  const boundingClientRect = element.getBoundingClientRect();\n\n  if (boundingClientRect) {\n    const viewportEntered = element.getAttribute('data-in-viewport-entered');\n\n    triggerDidEnterViewport(\n      element,\n      isInViewport(boundingClientRect, height, width, viewportTolerance),\n      viewportSpy,\n      enterCallback,\n      exitCallback,\n      viewportEntered,\n    );\n\n    if (viewportSpy || viewportEntered !== 'true') {\n      // recursive\n      // add to pool of requestAnimationFrame listeners and executed on set schedule\n      addRAF(\n        startRAF.bind(\n          this,\n          element,\n          { scrollableArea, viewportTolerance, viewportSpy },\n          enterCallback,\n          exitCallback,\n          addRAF,\n          removeRAF,\n        ),\n      );\n    } else {\n      removeRAF();\n    }\n  }\n}\n\nfunction triggerDidEnterViewport(\n  element,\n  hasEnteredViewport,\n  viewportSpy,\n  enterCallback,\n  exitCallback,\n  viewportEntered = false,\n) {\n  const didEnter =\n    (!viewportEntered || viewportEntered === 'false') && hasEnteredViewport;\n  const didLeave = viewportEntered === 'true' && !hasEnteredViewport;\n\n  if (didEnter) {\n    element.setAttribute('data-in-viewport-entered', true);\n    enterCallback();\n  }\n\n  if (didLeave) {\n    exitCallback();\n\n    // reset so we can call again\n    if (viewportSpy) {\n      element.setAttribute('data-in-viewport-entered', false);\n    }\n  }\n}\n"],"names":["RAFAdmin","constructor","_rafPool","RafPool","elementRegistry","WeakMap","add","args","flush","remove","reset","stop","addEnterCallback","element","enterCallback","set","Object","assign","get","addExitCallback","exitCallback","startRAF","scrollableArea","viewportTolerance","viewportSpy","addRAF","removeRAF","domScrollableArea","document","querySelector","HTMLElement","undefined","height","offsetHeight","getBoundingClientRect","top","window","innerHeight","width","offsetWidth","left","innerWidth","boundingClientRect","viewportEntered","getAttribute","triggerDidEnterViewport","isInViewport","bind","hasEnteredViewport","didEnter","didLeave","setAttribute"],"mappings":"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"}